name: Tests
on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  tests:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        # Intent: exercise the same interpreter set used for wheel builds.
        # Result: CI runs tests across supported CPython and free-threaded variants.
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.13t", "3.14", "3.14t"]
    steps:
      - uses: actions/checkout@v5
        with:
          submodules: false
      # Intent: install the Rust toolchain needed for maturin builds.
      # Result: the Rust extension can compile during pip install.
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      # Intent: ensure maturin and pip are available for PEP 517 builds.
      # Result: pip can build the Rust extension during installation.
      - name: Install build tooling
        run: python -m pip install --upgrade pip maturin
      - name: Build
        run: |
          python -m pip install .
          cd /tmp
          python -c "import bjoern"
        shell: bash -ex {0}
        env:
          # Intent: allow PyO3 to build against newer Python versions using the stable ABI.
          # Result: CI installs proceed on Python 3.13+ while waiting for PyO3 updates.
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"
      - name: Run tests
        run: |
          pip install requests
          python tests/interrupt-during-request.py
          python tests/keep-alive-behaviour.py
          python tests/test_wsgi_compliance.py
          python tests/expect100.py
        shell: bash -ex {0}
