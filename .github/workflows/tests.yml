name: Tests
on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  tests:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        # Intent: exercise the same interpreter set used for wheel builds.
        # Result: CI runs tests across supported CPython and free-threaded variants.
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.13t", "3.14", "3.14t"]
    steps:
      - uses: actions/checkout@v5
        with:
          submodules: true
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - run: sudo apt-get update && sudo apt-get install -y libev-dev
        if: matrix.os == 'ubuntu-latest'
      - run: brew install libev
        if: matrix.os == 'macos-latest'
      # Intent: ensure setup.py dependencies are available for installs.
      # Result: setuptools is installed before building bjoern.
      - name: Install build tooling
        run: python -m pip install --upgrade pip setuptools
      - name: Build
        run: |
          python setup.py install
          cd /tmp
          python -c "import bjoern"
        shell: bash -ex {0}
      - name: Run tests
        run: |
          pip install requests
          python tests/interrupt-during-request.py
          python tests/keep-alive-behaviour.py
          python tests/test_wsgi_compliance.py
          python tests/expect100.py
        shell: bash -ex {0}
